services:

  # ─── Databases ─────────────────────────────────────────────────────────────

  postgres_auth:
    image: postgres:17-alpine
    container_name: eventflow_postgres_auth
    environment:
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5432:5432"
    volumes:
      - postgres_auth_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d authdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres_core:
    image: postgres:17-alpine
    container_name: eventflow_postgres_core
    environment:
      POSTGRES_DB: coredb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5433:5432"
    volumes:
      - postgres_core_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d coredb"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres_worker:
    image: postgres:17-alpine
    container_name: eventflow_postgres_worker
    environment:
      POSTGRES_DB: workerdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5434:5432"
    volumes:
      - postgres_worker_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d workerdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres_notification:
    image: postgres:17-alpine
    container_name: eventflow_postgres_notification
    environment:
      POSTGRES_DB: notificationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    ports:
      - "5435:5432"
    volumes:
      - postgres_notification_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d notificationdb"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── RabbitMQ ──────────────────────────────────────────────────────────────

  rabbitmq:
    image: rabbitmq:4-management-alpine
    container_name: eventflow_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI (http://localhost:15672)
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ─── Redis ─────────────────────────────────────────────────────────────────

  redis:
    image: redis:7-alpine
    container_name: eventflow_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ─── Microservices ─────────────────────────────────────────────────────────

  gateway-api:
    build:
      context: ..
      dockerfile: gateway-api/Dockerfile
    container_name: eventflow_gateway
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_URLS: http://+:8080
      REDIS_HOST: redis
      JWT_SECRET: change-me-super-secret-key-at-least-32-chars!!
      JWT_ISSUER: eventflow-auth
      JWT_AUDIENCE: eventflow
      RATE_LIMIT_REQUESTS: "100"
      RATE_LIMIT_WINDOW_SECONDS: "60"
      ALLOWED_ORIGINS: http://localhost:3000
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  auth-service:
    build:
      context: ..
      dockerfile: auth-service/Dockerfile
    container_name: eventflow_auth
    environment:
      ASPNETCORE_URLS: http://+:5001
      POSTGRES_HOST: postgres_auth
      POSTGRES_PORT: 5432
      POSTGRES_DB: authdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      JWT_SECRET: change-me-super-secret-key-at-least-32-chars!!
      JWT_EXPIRY_MINUTES: "15"
      JWT_ISSUER: eventflow-auth
      JWT_AUDIENCE: eventflow
      REDIS_HOST: redis
      ALLOWED_ORIGINS: http://localhost:3000
      RUN_MIGRATIONS: "true"
    depends_on:
      postgres_auth:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  core-service:
    build:
      context: ..
      dockerfile: core-service/Dockerfile
    container_name: eventflow_core
    environment:
      ASPNETCORE_URLS: http://+:5002
      POSTGRES_HOST: postgres_core
      POSTGRES_PORT: 5432
      POSTGRES_DB: coredb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      JWT_SECRET: change-me-super-secret-key-at-least-32-chars!!
      JWT_ISSUER: eventflow-auth
      JWT_AUDIENCE: eventflow
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      ALLOWED_ORIGINS: http://localhost:3000
      RUN_MIGRATIONS: "true"
    depends_on:
      postgres_core:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  worker-service:
    build:
      context: ..
      dockerfile: worker-service/Dockerfile
    container_name: eventflow_worker
    environment:
      POSTGRES_HOST: postgres_worker
      POSTGRES_PORT: 5432
      POSTGRES_DB: workerdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      RUN_MIGRATIONS: "true"
    depends_on:
      postgres_worker:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

  notification-service:
    build:
      context: ..
      dockerfile: notification-service/Dockerfile
    container_name: eventflow_notification
    environment:
      POSTGRES_HOST: postgres_notification
      POSTGRES_PORT: 5432
      POSTGRES_DB: notificationdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USER: guest
      RABBITMQ_PASS: guest
      RUN_MIGRATIONS: "true"
    depends_on:
      postgres_notification:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    restart: unless-stopped

# ─── Volumes ───────────────────────────────────────────────────────────────

volumes:
  postgres_auth_data:
  postgres_core_data:
  postgres_worker_data:
  postgres_notification_data:
  rabbitmq_data:
  redis_data:
